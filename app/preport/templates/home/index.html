
{% extends "home/template.html" %}

{% load i18n%}
{% load martortags %}

{% block title %} {% translate "Dashboard" %} {% endblock title %}

{% block stylesheets %}
  {{ block.super }}
{% endblock stylesheets %}


{% block content %}


<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 p-2">
  <!-- Customer Card -->
  <div class="card rounded-lg bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class=" font-poppins">{{ total_customers }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Customer" %}{{ total_customers|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>

  <!-- Product Card -->
  <div class="card rounded-lg bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class=" font-poppins">{{ total_products }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Product" %}{{ total_products|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>

  <!-- Report Card -->
  <div class="card rounded-lg bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class=" font-poppins">{{ total_reports }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Report" %}{{ total_reports|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>

  <!-- Deliverable Card -->
  <div class="card rounded-lg shadow-xl hover:shadow-inner">
    <div class="card-body">
      <h2 class=" font-poppins">{{ total_deliverables }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Deliverable" %}{{ total_deliverables|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>

  <!-- Finding Card -->
  <div class="card rounded-lg bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class=" font-poppins">{{ count_product_findings_total }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Finding" %}{{ count_product_findings_total|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>

  <!-- Critical/High Finding Card -->
  <div class="card rounded-lg bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class=" font-poppins">{{ count_product_findings_critical_high }}</h2>
      <div class="flex justify-between">
        <h2 class="card-title font-poppins">{% translate "Critical/High Finding" %}{{ count_product_findings_critical_high|pluralize:"s" }}</h2>
      </div>
    </div>
  </div>
</div>

<div class="flex w-full p-2 gap-2">
  <div class="card rounded-lg bg-base-100 w-full shadow-xl">
    <div class="card-body">
      <div class="flex justify-between items-center">
        <h2 class="card-title font-poppins">{% translate "Overall Breakdown by Categories" %}</h2>
        <button id="toggleChartBtn" class="btn btn-primary btn-sm">
          Column Chart
        </button>
      </div>
      <div id="CWEPieChartApex" style="width: 100%; height: 400px;" class="flex items-center justify-center"></div>
    </div>
  </div>

  <div class="card rounded-lg bg-base-100 w-full shadow-xl">
    <div class="card-body">
      <h2 class="card-title font-poppins">{% translate "Vulnerabilities by status" %}</h2>
      <div id="StatusPieDoughnutEcharts" style="width:100%; height:400px;"></div>
    </div>
  </div>
</div>

<div class="flex w-full p-2 gap-2">
  <div class="card rounded-lg bg-base-100 w-full shadow-xl">
    <div class="card-body">
      <h2 class="card-title font-poppins">{% translate "Overall Breakdown by OWASP Top Ten Application Security Risks" %}</h2>
      <div id="OWASPPieChartEcharts" style="width:100%; height:400px;"></div>
    </div>
  </div>

  <div class="card rounded-lg bg-base-100 w-full shadow-xl">
    <div class="card-body">
      <h2 class="card-title font-poppins">{% translate "Vulnerabilities by severity" %}</h2>
      <div id="VulnPieDoughnutEcharts" style="width:100%; height:400px;"></div>
    </div>
  </div>
</div>


<div class="flex w-full p-2 gap-2">
<div class="card rounded-lg bg-base-100 w-full shadow-xl">
  <div class="card-body">
    <h2 class="card-title font-poppins">{% translate "Top 10 risk findings" %}</h2>
    <div class="overflow-x-auto">
      <table class="table">
        <!-- head -->
        <thead>
          <tr class="font-poppins">
            <th>{% translate "Customer" %}</th>
            <th>{% translate "Product" %}</th>
            <th>{% translate "Report" %}</th>
            <th>{% translate "Finding" %}</th>
            <th>{% translate "Risk Score" %}</th>
          </tr>
        </thead>
          <tbody class="font-poppins">

            {% for finding in DB_finding_query %}
              <tr>

                <td><a href="{% url 'customer_view' finding.report.product.customer.pk %}">{{ finding.report.product.customer.name }}</a></td>

                <td><a href="{% url 'product_view' finding.report.product.pk %}">{{ finding.report.product.name }}</a></td>

                <td><a href="{% url 'report_view' finding.report.pk %}">{{ finding.report.title }}</a></td>

                {% if finding.cvss_score >= 9 %}
                <td class="last">
                  <b>
                    <a href="{% url 'finding_view' finding.pk %}" class="text-red-600">
                      <i class="fa fa-exclamation-circle"></i> {{ finding.title }}
                    </a>
                  </b>
                </td>
                <td>
                  <div class="badge badge-error gap-2">Critical {{ finding.cvss_score }}</div>
                </td>
              {% elif finding.cvss_score >= 7 %}
                <td class="last">
                  <b>
                    <a href="{% url 'finding_view' finding.pk %}" class="text-red-500">
                      <i class="fa fa-exclamation-triangle"></i> {{ finding.title }}
                    </a>
                  </b>
                </td>
                <td>
                  <div class="badge badge-error gap-2">High {{ finding.cvss_score }}</div>
                </td>
              {% elif finding.cvss_score >= 4 %}
                <td class="last">
                  <b>
                    <a href="{% url 'finding_view' finding.pk %}" class="text-orange-500">
                      <i class="fa fa-exclamation-triangle"></i> {{ finding.title }}
                    </a>
                  </b>
                </td>
                <td>
                  <div class="badge badge-warning gap-2">Medium {{ finding.cvss_score }}</div>
                </td>
              {% elif finding.cvss_score >= 0.1 %}
                <td class="last">
                  <b>
                    <a href="{% url 'finding_view' finding.pk %}" class="text-green-500">
                      <i class="fa fa-bug"></i> {{ finding.title }}
                    </a>
                  </b>
                </td>
                <td>
                  <div class="badge badge-success gap-2">Low {{ finding.cvss_score }}</div>
                </td>
              {% else %}
                <td class="last">
                  <b>
                    <a href="{% url 'finding_view' finding.pk %}" class="text-blue-500">
                      <i class="fa fa-bug"></i> {{ finding.title }}
                    </a>
                  </b>
                </td>
                <td>
                  <div class="badge badge-info gap-2">Info {{ finding.cvss_score }}</div>
                </td>
              {% endif %}
              

            {% endfor %}
              
            </tbody>
      </table>
    </div>
  </div>
</div>
</div>



{% endblock content %}

{% block javascripts %}
  {{ block.super}}

<script>

(function($,sr){
    // debouncing function from John Hann
    // http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
    var debounce = function (func, threshold, execAsap) {
      var timeout;

        return function debounced () {
            var obj = this, args = arguments;
            function delayed () {
                if (!execAsap)
                    func.apply(obj, args); 
                timeout = null; 
            }

            if (timeout)
                clearTimeout(timeout);
            else if (execAsap)
                func.apply(obj, args);

            timeout = setTimeout(delayed, threshold || 100); 
        };
    };

    // smartresize 
    jQuery.fn[sr] = function(fn){  return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr); };

})(jQuery,'smartresize');
/**
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

var CURRENT_URL = window.location.href.split('#')[0].split('?')[0],
    $BODY = $('body'),
    $MENU_TOGGLE = $('#menu_toggle'),
    $SIDEBAR_MENU = $('#sidebar-menu'),
    $SIDEBAR_FOOTER = $('.sidebar-footer'),
    $LEFT_COL = $('.left_col'),
    $RIGHT_COL = $('.right_col'),
    $NAV_MENU = $('.nav_menu'),
    $FOOTER = $('footer');
</script>



<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script type="text/javascript">
  // Data format from the server
  const cweCategories = {{ cwe_categories|safe }}; // Ensure this is a JSON array of objects with `name` and `value`

  // Extract labels and data for ApexCharts
  const labels = cweCategories.map(item => item.name);
  const series = cweCategories.map(item => item.value);

  // Initial chart options for the pie chart
  const pieChartOptions = {
    chart: {
      type: 'pie',
      height: 400,
    },
    labels: labels,
    series: series,
    tooltip: {
      y: {
        formatter: function (value) {
          return value; // Custom formatter for the value if needed
        },
      },
    },
    legend: {
      position: 'left',
      horizontalAlign: 'center',
      labels: {
        style: {
          fontFamily: 'poppins', // Set font family to Poppins
          fontSize: '10px', // Optional: Set font size
          color: '#000', // Optional: Set font color
          fontWeight: '500',
        },
      },
    },
    responsive: [
      {
        breakpoint: 768,
        options: {
          chart: {
            width: '100%',
          },
          legend: {
            position: 'bottom',
          },
        },
      },
    ],
  };
  

  // Chart options for the column chart
  const columnChartOptions = {
    chart: {
      type: 'bar',
      height: 400,
    },
    xaxis: {
      labels: {
        show: false,
      },
    },
    series: [
      {
        name: "{% translate 'Categories' %}",
        data: series,
      },
    ],
    tooltip: {
      y: {
        formatter: function (value) {
          return value; // Custom formatter for the value if needed
        },
      },
    },
    plotOptions: {
      bar: {
        horizontal: true,
        columnWidth: '50%',
      },
    },
    legend: {
      show: false,
    },
  };

  // Render the initial pie chart
  let currentChartType = 'pie';
  let chart = new ApexCharts(document.querySelector("#CWEPieChartApex"), pieChartOptions);
  chart.render();

  // Add event listener for the toggle button
  document.querySelector("#toggleChartBtn").addEventListener("click", () => {
    // Destroy the current chart instance
    chart.destroy();

    // Toggle the chart type and update the button text
    if (currentChartType === 'pie') {
      currentChartType = 'column';
      chart = new ApexCharts(document.querySelector("#CWEPieChartApex"), columnChartOptions);
      document.querySelector("#toggleChartBtn").innerText = "Switch to Pie Chart";
    } else {
      currentChartType = 'pie';
      chart = new ApexCharts(document.querySelector("#CWEPieChartApex"), pieChartOptions);
      document.querySelector("#toggleChartBtn").innerText = "Switch to Column Chart";
    }

    // Render the new chart
    chart.render();
  });
</script>



<script type="text/javascript">
    var chart_OWASP = echarts.init(document.getElementById('OWASPPieChartEcharts'));

    var option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b} <br>{c}'
            },
            toolbox: {
              show: true,
              feature: {
                  saveAsImage: {
                    show: false,
                    title: "Save Image",
                    name: "Breakdown_by_OWASP_Categories"
                  }
              }
            },
            series: [
                {
                    name: 'OWASP',
                    type: 'pie',
                    radius: '70%',
                    animation: false,

                    data: {{owasp_categories|safe}},
                    labelLine: {
                        show: true
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
    };

    chart_OWASP.setOption(option);

</script>



<script type="text/javascript">
    var chart_Vuln = echarts.init(document.getElementById('VulnPieDoughnutEcharts'));

    var option = {
          tooltip: {
            trigger: 'item'
          },
          legend: {
            top: '5%',
            left: 'center'
          },
          series: [
            {
              name: '{% translate "Vulnerabilities" %}',
              type: 'pie',
              radius: ['40%', '70%'],
              avoidLabelOverlap: false,
              itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
              },
              label: {
                show: false,
                position: 'center'
              },
              emphasis: {
                label: {
                  show: false,
                  fontSize: 40,
                  fontWeight: 'bold'
                }
              },
              labelLine: {
                show: false
              },
              data: [
                { value: {{count_product_findings_critical}}, name: '{% translate "Critical" %}', itemStyle: {color: '#cc0000'} },
                { value: {{count_product_findings_high}}, name: '{% translate "High" %}', itemStyle: {color: '#ff403d'}  },
                { value: {{count_product_findings_medium}}, name: '{% translate "Medium" %}', itemStyle: {color: '#fc7f03'}  },
                { value: {{count_product_findings_low}}, name: '{% translate "Low" %}', itemStyle: {color: '#05b04f'}  },
                { value: {{count_product_findings_info}}, name: '{% translate "Info" %}', itemStyle: {color: '#45a7f7'}  }              ]
            }
          ]
        };

    chart_Vuln.setOption(option);

</script>


<script type="text/javascript">
    var chart_status = echarts.init(document.getElementById('StatusPieDoughnutEcharts'));

    var option = {
          tooltip: {
            trigger: 'item'
          },
          legend: {
            top: '5%',
            left: 'center'
          },
          series: [
            {
              name: '{% translate "Status" %}',
              type: 'pie',
              radius: ['40%', '70%'],
              avoidLabelOverlap: false,
              itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
              },
              label: {
                show: false,
                position: 'center'
              },
              emphasis: {
                label: {
                  show: false,
                  fontSize: 40,
                  fontWeight: 'bold'
                }
              },
              labelLine: {
                show: false
              },
              data: [
                { value: {{count_open_findings}}, name: '{% translate "Open" %}', itemStyle: {color: 'blue'} },
                { value: {{count_closed_findings}}, name: '{% translate "Closed" %}', itemStyle: {color: 'green'} }              ]
            }
          ]
        };
    chart_status.setOption(option);

</script>


<script type="text/javascript">
  var chart_OWASP = echarts.init(document.getElementById('OWASPPolarAreaChartEcharts'));

  var option = {
      tooltip: {
          trigger: 'item',
          formatter: '{b} <br>{c}'
      },
      toolbox: {
          show: true,
          feature: {
              saveAsImage: {
                  show: false,
                  title: "Save Image",
                  name: "Breakdown_by_OWASP_Categories"
              }
          }
      },
      angleAxis: {
          type: 'category',
          data: {{owasp_categories|safe}}.map(item => item.name),  // Using category names from data
          z: 10
      },
      radiusAxis: {
          type: 'value'
      },
      polar: {},
      series: [
          {
              name: 'OWASP',
              type: 'pie',
              radius: ['30%', '70%'],
              center: ['50%', '50%'],
              data: {{owasp_categories|safe}},
              label: {
                  show: true,
                  position: 'outside'
              },
              emphasis: {
                  itemStyle: {
                      shadowBlur: 10,
                      shadowOffsetX: 0,
                      shadowColor: 'rgba(0, 0, 0, 0.5)'
                  }
              }
          }
      ]
  };

  chart_OWASP.setOption(option);
</script>

{% endblock javascripts %}